{"version":3,"file":"stellarbroker.js","mappings":"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","sources":["webpack://stellarbroker/webpack/universalModuleDefinition","webpack://stellarbroker/external umd \"@stellar/stellar-base\"","webpack://stellarbroker/webpack/bootstrap","webpack://stellarbroker/webpack/runtime/define property getters","webpack://stellarbroker/webpack/runtime/hasOwnProperty shorthand","webpack://stellarbroker/./src/errors.js","webpack://stellarbroker/./src/events.js","webpack://stellarbroker/./src/quote-request.js","webpack://stellarbroker/./src/client.js","webpack://stellarbroker/./src/index.js"],"sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory(require(\"@stellar/stellar-base\"));\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine([\"@stellar/stellar-base\"], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"stellarbroker\"] = factory(require(\"@stellar/stellar-base\"));\n\telse\n\t\troot[\"stellarbroker\"] = factory(root[\"@stellar/stellar-base\"]);\n})(this, (__WEBPACK_EXTERNAL_MODULE__755__) => {\nreturn ","module.exports = __WEBPACK_EXTERNAL_MODULE__755__;","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","export class StellarBrokerError extends Error {\r\n    constructor(code, message) {\r\n        super(message)\r\n        this.code = code\r\n    }\r\n\r\n    /**\r\n     * Numeric error code\r\n     * @type {number}\r\n     * @readonly\r\n     */\r\n    code = 0\r\n}\r\n\r\nconst errors = {\r\n    invalidInitParam(param) {\r\n        return new StellarBrokerError(1, `Invalid parameter value: \"${param}\"`)\r\n    },\r\n    invalidAuthorizationParam() {\r\n        return new StellarBrokerError(2, 'Invalid authorization secret key or callback provided')\r\n    },\r\n    quoteNotSet() {\r\n        return new StellarBrokerError(11, 'Price quote not available')\r\n    },\r\n    quoteExpired() {\r\n        return new StellarBrokerError(12, 'Price quote expired')\r\n    },\r\n    quoteError(message) {\r\n        return new StellarBrokerError(13, 'Price quotation error: ' + message)\r\n    },\r\n    invalidQuoteParam(invalidParamName, details) {\r\n        return new StellarBrokerError(14, `Invalid quote request parameter: \"${invalidParamName}\". ${details}`)\r\n    },\r\n    tradeInProgress() {\r\n        return new StellarBrokerError(20, 'Cannot change quote while trade is in progress')\r\n    },\r\n    invalidSwapTx() {\r\n        return new StellarBrokerError(21, 'Invalid swap transaction received')\r\n    },\r\n    failedToSignTx() {\r\n        return new StellarBrokerError(22, 'Failed to sign received transaction')\r\n    },\r\n    unsupportedEventType(type) {\r\n        return new StellarBrokerError(31, 'Unknown event type: ' + type)\r\n    },\r\n    serverError(message) {\r\n        return new StellarBrokerError(101, 'Server error: ' + message)\r\n    }\r\n}\r\n\r\nexport default errors","/**\r\n * @param {string} type\r\n * @param {{}} data\r\n * @param {string} [key]\r\n * @return {CustomEvent}\r\n */\r\nexport function buildEvent(type, data, key) {\r\n    const evt = new CustomEvent(type, {detail: data})\r\n    evt[key || type] = data\r\n    return evt\r\n}","import {StrKey} from '@stellar/stellar-base'\r\nimport errors from './errors.js'\r\n\r\n/**\r\n * @typedef {object} SwapQuoteParams\r\n * @property {string} sellingAsset - Asset to sell\r\n * @property {string} buyingAsset - Asset to buy\r\n * @property {string} [sellingAmount] - Amount of selling asset\r\n * @property {string} [buyingAmount] - Amount of buying asset\r\n * @property {number} [slippageTolerance] - Swap slippage tolerance (0.02 by default - 2%)\r\n * @property {string} [destination] - Trader account address\r\n */\r\n\r\n/**\r\n * @param {SwapQuoteParams} params\r\n * @return {SwapQuoteParams}\r\n */\r\nexport function validateQuoteRequest(params) {\r\n    const {\r\n        destination, sellingAsset, selling_asset, buyingAsset, buying_asset, sellingAmount, selling_amount,\r\n        buyingAmount, buying_amount, slippageTolerance, slippage_tolerance, ...other\r\n    } = params\r\n    const res = {\r\n        sellingAsset: parseAsset(sellingAsset || selling_asset, 'sellingAsset'),\r\n        buyingAsset: parseAsset(buyingAsset || buying_asset, 'buyingAsset'),\r\n        sellingAmount: parseAmount(sellingAmount || selling_amount, 'sellingAmount'),\r\n        buyingAmount: parseAmount(buyingAmount || buying_amount, 'buyingAmount'),\r\n        slippageTolerance: parseSlippageTolerance(slippageTolerance || slippage_tolerance || 0.02, 'slippageTolerance'),\r\n        flow: 'direct'\r\n    }\r\n    if (destination) {\r\n        res.destination = validateAccount(destination, 'destination', true)\r\n    }\r\n    if (res.buyingAsset === res.sellingAsset)\r\n        throw errors.invalidQuoteParam('buyingAsset', 'Buying asset can\\'t be the same as selling asset')\r\n    if (res.buyingAmount === undefined && res.sellingAmount === undefined)\r\n        throw errors.invalidQuoteParam('sellingAmount', 'Either \"buyingAmount\" or \"sellingAmount\" parameter is required')\r\n    if (res.buyingAmount !== undefined && res.sellingAmount !== undefined)\r\n        throw errors.invalidQuoteParam('sellingAmount', 'Parameters \"buyingAmount\" and \"sellingAmount\" are mutually exclusive')\r\n    Object.assign(res, other) //add remaining optional params\r\n    return res\r\n}\r\n\r\nfunction parseAsset(asset, parameter) {\r\n    if (typeof asset === 'string') {\r\n        if (asset === 'XLM' || asset === 'xlm' || asset === 'native')\r\n            return 'XLM'\r\n        if (asset.includes(':')) {\r\n            const [code, issuer] = asset.split(':')\r\n            validateCode(code)\r\n            validateAccount(issuer, parameter)\r\n            return code + '-' + issuer\r\n        }\r\n        if (asset.includes('-')) {\r\n            const [code, issuer] = asset.split('-')\r\n            validateCode(code)\r\n            validateAccount(issuer, parameter)\r\n            return asset\r\n        }\r\n    }\r\n    throw errors.invalidQuoteParam(parameter, 'Invalid asset')\r\n}\r\n\r\nfunction validateCode(code, parameter) {\r\n    if (!/^[a-zA-Z0-9]{1,12}$/.test(code))\r\n        throw errors.invalidQuoteParam(parameter, 'Invalid asset code: ' + (code === undefined ? 'missing' : code))\r\n    return code\r\n}\r\n\r\nfunction validateAccount(account, param, optional = false) {\r\n    if (account === undefined && optional)\r\n        return undefined\r\n    if (!StrKey.isValidEd25519PublicKey(account))\r\n        throw errors.invalidQuoteParam(param, 'Invalid account address: ' + (account === undefined ? 'missing' : account))\r\n    return account\r\n}\r\n\r\nfunction parseAmount(amount, parameter) {\r\n    if (amount === undefined)\r\n        return undefined\r\n    const parsed = parseFloat(amount)\r\n    if (isNaN(parsed) || parsed <= 0)\r\n        throw errors.invalidQuoteParam(parameter, 'Invalid asset amount: ' + amount)\r\n    return amount\r\n}\r\n\r\nfunction parseSlippageTolerance(src, parameter) {\r\n    const tolerance = parseFloat(src)\r\n    if (isNaN(tolerance))\r\n        throw errors.invalidQuoteParam(parameter, 'Invalid slippage tolerance, number expected')\r\n    if (tolerance < 0)\r\n        throw errors.invalidQuoteParam(parameter, 'Slippage tolerance is too small, expected value >= 0')\r\n    if (tolerance > 0.5)\r\n        throw errors.invalidQuoteParam(parameter, 'Slippage tolerance is too large, expected value < 0.5 (50%)')\r\n    return tolerance\r\n}","import {Networks, TransactionBuilder, Keypair, FeeBumpTransaction} from '@stellar/stellar-base'\r\nimport errors from './errors.js'\r\nimport {buildEvent} from './events.js'\r\nimport {validateQuoteRequest} from './quote-request.js'\r\n\r\nexport default class StellarBrokerClient {\r\n    /**\r\n     * @param {ClientInitializationParams} params\r\n     */\r\n    constructor(params) {\r\n        if (!params.network)\r\n            throw errors.invalidInitParam('network')\r\n        this.partnerKey = params.partnerKey\r\n        this.emitter = new EventTarget()\r\n        this.network = Networks[params.network.toUpperCase()] || params.network\r\n        this.flow = params.flow || 'direct'\r\n    }\r\n\r\n    /**\r\n     * @type {ClientStatus}\r\n     * @readonly\r\n     */\r\n    status = 'disconnected'\r\n    /**\r\n     * @type {WebSocket}\r\n     * @private\r\n     */\r\n    socket\r\n    /**\r\n     * @type {EventTarget}\r\n     * @private\r\n     */\r\n    emitter\r\n    /**\r\n     * @type {string}\r\n     * @private\r\n     */\r\n    origin = 'https://api.stellar.broker'\r\n    /**\r\n     * Stellar network passphrase\r\n     * @type {string}\r\n     * @readonly\r\n     */\r\n    network = ''\r\n    /**\r\n     * Last quote request submitted by the client\r\n     * @type {SwapQuoteParams}\r\n     * @private\r\n     */\r\n    quoteRequest\r\n    /**\r\n     * Last quote received from the sever\r\n     * @type {SwapQuoteResult}\r\n     * @readonly\r\n     */\r\n    lastQuote\r\n    /**\r\n     * Current quote accepted for the trading\r\n     * @private\r\n     */\r\n    tradeQuote\r\n    /**\r\n     * API key of the partner\r\n     * @type {string}\r\n     * @private\r\n     */\r\n    partnerKey\r\n    /**\r\n     * Account secret key (for direct swap flow)\r\n     * @type {Keypair|ClientAuthorizationCallback}\r\n     * @private\r\n     */\r\n    authorization\r\n\r\n    /**\r\n     * Trader account public key\r\n     * @type {string}\r\n     */\r\n    get source() {\r\n        return this.quoteRequest?.destination\r\n    }\r\n\r\n    /**\r\n     * Connect to the StellarBroker server\r\n     * @return {Promise<StellarBrokerClient>}\r\n     */\r\n    connect() {\r\n        if (this.socket?.readyState === WebSocket.OPEN)\r\n            return Promise.resolve(this) //already opened\r\n\r\n        this.socket = new WebSocket(this.origin + '/ws?partner=' + encodeURIComponent(this.partnerKey))\r\n        this.socket.onmessage = this.processMessage.bind(this)\r\n        this.socket.onclose = () => {\r\n            console.log('Connection closed')\r\n            this.status = 'disconnected'\r\n        }\r\n\r\n        this.socket.onerror = e => console.error(e)\r\n\r\n        return new Promise((confirm, reject) => { //TODO: use 'once'\r\n            const expirationTimeout = setTimeout(() => reject(this), 2000) // 2s timeout\r\n            this.onSocketOpen = () => {\r\n                this.status = 'ready'\r\n                this.heartbeat()\r\n                this.onSocketOpen = undefined\r\n                clearTimeout(expirationTimeout)\r\n                confirm(this)\r\n            }\r\n        })\r\n    }\r\n\r\n    /**\r\n     * Process incoming message\r\n     * @param message\r\n     * @private\r\n     */\r\n    processMessage(message) {\r\n        const raw = JSON.parse(message.data)\r\n        switch (raw.type) {\r\n            case 'connected':\r\n                if (this.onSocketOpen) {\r\n                    this.onSocketOpen()\r\n                }\r\n                break\r\n            case 'quote':\r\n                this.lastQuote = raw.quote\r\n                this.lastQuote.ts = new Date()\r\n                //send event to the client app\r\n                this.emitter.dispatchEvent(buildEvent('quote', this.lastQuote))\r\n                break\r\n            case 'tx':\r\n                if (this.status !== 'trade') {\r\n                    console.log('Received tx in non-trading state', this.status, raw)\r\n                    return //skip unless trading is in progress\r\n                }\r\n                this.processTxRequest(raw)\r\n                break\r\n            case 'stop':\r\n                this.emitter.dispatchEvent(buildEvent('finished', {\r\n                    status: raw.status,\r\n                    sold: raw.sold,\r\n                    bought: raw.bought\r\n                }, 'result'))\r\n                this.status = 'ready'\r\n                break\r\n            case 'progress':\r\n                this.emitter.dispatchEvent(buildEvent('progress', {\r\n                    sold: raw.sold,\r\n                    bought: raw.bought\r\n                }, 'status'))\r\n                break\r\n            case 'ping':\r\n                this.heartbeat()\r\n                this.send({type: 'pong'})\r\n                break\r\n            case 'error':\r\n                this.stop()\r\n                this.emitter.dispatchEvent(buildEvent('error', 'Server error: ' + raw.error))\r\n                break\r\n            default:\r\n                console.log('Unknown message type: ' + raw.type)\r\n                break\r\n        }\r\n    }\r\n\r\n    /**\r\n     * Request swap quote\r\n     * @param {SwapQuoteParams} params - Quote parameters\r\n     */\r\n    quote(params) {\r\n        if (this.status === 'trade')\r\n            throw errors.tradeInProgress()\r\n        this.quoteRequest = validateQuoteRequest(params)\r\n        this.status = 'quote'\r\n        this.connect()\r\n            .then(() => {\r\n                this.send({\r\n                    type: 'quote',\r\n                    ...this.quoteRequest\r\n                })\r\n            })\r\n    }\r\n\r\n    /**\r\n     * Stop quotation/trading\r\n     */\r\n    stop() {\r\n        if (this.status !== 'trade' && this.status !== 'quote')\r\n            return\r\n        this.send({\r\n            type: 'stop'\r\n        })\r\n        this.tradeQuote = undefined\r\n        this.status = 'ready'\r\n    }\r\n\r\n    /**\r\n     * Confirm current quote and start trading\r\n     * @param {string|ClientAuthorizationCallback} authorization - Authorization method, either account secret key or an authorization callback\r\n     */\r\n    confirmQuote(authorization) {\r\n        if (this.status !== 'quote')\r\n            throw errors.tradeInProgress()\r\n        if (!this.lastQuote)\r\n            throw errors.quoteNotSet()\r\n        if ((new Date() - this.lastQuote.ts) > 7000) //do not allow stale quotes quoted more than 7s ago\r\n            throw errors.quoteExpired()\r\n        if (this.lastQuote.status !== 'success')\r\n            throw errors.quoteError(this.lastQuote.error || 'quote not available')\r\n        if (typeof authorization === 'string') {\r\n            try {\r\n                this.authorization = Keypair.fromSecret(authorization)\r\n            } catch (e) {\r\n                throw errors.invalidAuthorizationParam()\r\n            }\r\n        } else if (typeof authorization === 'function') {\r\n            this.authorization = authorization\r\n        }\r\n        this.tradeQuote = this.lastQuote\r\n        this.send({\r\n            type: 'trade'\r\n        })\r\n        this.status = 'trade'\r\n    }\r\n\r\n    /**\r\n     * @param {{xdr: string, hash: string}} raw\r\n     * @private\r\n     */\r\n    processTxRequest(raw) {\r\n        //parse incoming transaction\r\n        let tx\r\n        try {\r\n            tx = TransactionBuilder.fromXDR(raw.xdr, this.network)\r\n        } catch (e) {\r\n            throw errors.invalidSwapTx()\r\n        }\r\n        //check that transaction is correct\r\n        if (!this.validateTransaction(tx))\r\n            throw errors.invalidSwapTx()\r\n        //sign transaction\r\n        this.authorizeTx(tx, raw.networkFee)\r\n            .then(tx => {\r\n                if (!tx || tx.signatures.length < 1)\r\n                    return console.error(`Transaction ${raw.hash} not signed`)\r\n                //respond with signed transaction\r\n                this.send({\r\n                    type: 'tx',\r\n                    hash: raw.hash,\r\n                    xdr: tx.toXDR()\r\n                })\r\n            })\r\n            .catch(e => {\r\n                console.error(e)\r\n                throw errors.failedToSignTx()\r\n            })\r\n    }\r\n\r\n    /**\r\n     * @param {Transaction} tx\r\n     * @param {string} networkFee\r\n     * @return {Promise<FeeBumpTransaction>}\r\n     * @private\r\n     */\r\n    async authorizeTx(tx, networkFee) {\r\n        //sign tx\r\n        if (this.authorization instanceof Keypair) {\r\n            tx.sign(this.authorization)\r\n        } else {\r\n            tx = await ensurePromise(this.authorization(tx))\r\n        }\r\n        //wrap with fee bump\r\n        let wrapped = TransactionBuilder.buildFeeBumpTransaction(this.source, networkFee, tx, this.network)\r\n        //sign fee bump wrapper tx\r\n        if (this.authorization instanceof Keypair) {\r\n            wrapped.sign(this.authorization)\r\n        } else {\r\n            wrapped = await ensurePromise(this.authorization(wrapped))\r\n        }\r\n        return wrapped\r\n    }\r\n\r\n    /**\r\n     * @param {Transaction} tx\r\n     * @throws {StellarBrokerError} Invalid swap transaction received\r\n     */\r\n    validateTransaction(tx) {\r\n        /*if (!(tx instanceof FeeBumpTransaction))\r\n            return false\r\n        const {innerTransaction} = tx\r\n        if (tx.feeSource !== this.source)\r\n            return false*/\r\n        for (let swap of tx.operations) {\r\n            if (swap.type !== 'pathPaymentStrictSend' && swap.type !== 'pathPaymentStrictReceive')\r\n                return false\r\n            const isFee = swap.destination !== this.source\r\n            if (isFee) {\r\n                if (swap.type !== 'pathPaymentStrictSend')\r\n                    return false\r\n                if ((swap.source && swap.source !== this.source))\r\n                    return false\r\n            } else {\r\n                if ((swap.source && swap.source !== swap.destination) || swap.destination !== this.source)\r\n                    return false\r\n            }\r\n        }\r\n        //TODO: check assets and amounts\r\n        return true\r\n    }\r\n\r\n    /**\r\n     * @param {{}} data\r\n     * @private\r\n     */\r\n    send(data) {\r\n        this.socket.send(JSON.stringify(data))\r\n    }\r\n\r\n    heartbeat() {\r\n        clearTimeout(this.pingHandler)\r\n        this.pingHandler = setTimeout(() => {\r\n            console.warn('Lost connection with the server')\r\n            this.socket.close()\r\n        }, 11_000) // 11 seconds heartbeat timeout\r\n    }\r\n\r\n    /**\r\n     * Add event listener\r\n     * @param {StellarBrokerClientEvent} type\r\n     * @param {function} callback\r\n     */\r\n    on(type, callback) {\r\n        if (!StellarBrokerEvents.includes(type))\r\n            throw errors.unsupportedEventType(type)\r\n        this.emitter.addEventListener(type, callback)\r\n    }\r\n\r\n    /**\r\n     * Add event listener that will be executed once\r\n     * @param {StellarBrokerClientEvent} type\r\n     * @param {function} callback\r\n     */\r\n    once(type, callback) {\r\n        if (!StellarBrokerEvents.includes(type))\r\n            throw errors.unsupportedEventType(type)\r\n        this.emitter.addEventListener(type, callback, {once: true})\r\n    }\r\n\r\n    /**\r\n     * Remove event listener\r\n     * @param {StellarBrokerClientEvent} type\r\n     * @param {function} callback\r\n     */\r\n    off(type, callback) {\r\n        if (!StellarBrokerEvents.includes(type))\r\n            throw errors.unsupportedEventType(type)\r\n        this.emitter.removeEventListener(type, callback)\r\n    }\r\n\r\n    /**\r\n     * Close underlying connection and finalize the client\r\n     */\r\n    close() {\r\n        try {\r\n            this.socket.close()\r\n        } catch (e) {\r\n        }\r\n    }\r\n}\r\n\r\nexport const StellarBrokerEvents = ['quote', 'finished', 'progress', 'error']\r\n\r\nfunction ensurePromise(callResult) {\r\n    if (!callResult instanceof Promise) {\r\n        if (callResult)\r\n            return Promise.resolve(callResult)\r\n        return Promise.reject()\r\n    }\r\n    return callResult\r\n}\r\n\r\n/**\r\n * @typedef {object} ClientInitializationParams\r\n * @property {string} [network] - Stellar network identifier or passphrase\r\n * @property {string} [partnerKey] - Partner key\r\n * @property {SwapFlowMode} [flow] - Swap flow mode\r\n */\r\n\r\n/**\r\n * @typedef {'disconnected'|'ready'|'quote'|'trade'} ClientStatus\r\n */\r\n\r\n/**\r\n * @typedef {'quote'|'finished'|'progress'|'error'} StellarBrokerClientEvent\r\n */\r\n\r\n/**\r\n * @typedef {'direct'} SwapFlowMode\r\n */\r\n\r\n/**\r\n * @typedef {object} SwapQuoteResult\r\n * @property {string} sellingAsset\r\n * @property {string} buyingAsset\r\n * @property {number} slippageTolerance\r\n * @property {string} destination\r\n * @property {number} ledger\r\n * @property {string} [sellingAmount]\r\n * @property {string} [estimatedBuyingAmount]\r\n * @property {string} [buyingAmount]\r\n * @property {string} [estimatedSellingAmount]\r\n * @property {{selling: string, buying: string, path: string[]}} [directTrade]\r\n */\r\n\r\n/**\r\n * @typedef {function(FeeBumpTransaction):Promise<FeeBumpTransaction>} ClientAuthorizationCallback\r\n */","import StellarBrokerClient from './client.js'\r\n\r\nexport default StellarBrokerClient"],"names":["root","factory","exports","module","require","define","amd","this","__WEBPACK_EXTERNAL_MODULE__755__","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","undefined","__webpack_modules__","d","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","StellarBrokerError","Error","constructor","code","message","super","invalidInitParam","param","invalidAuthorizationParam","quoteNotSet","quoteExpired","quoteError","invalidQuoteParam","invalidParamName","details","tradeInProgress","invalidSwapTx","failedToSignTx","unsupportedEventType","type","serverError","buildEvent","data","evt","CustomEvent","detail","parseAsset","asset","parameter","includes","issuer","split","validateCode","validateAccount","errors","test","account","optional","StrKey","isValidEd25519PublicKey","parseAmount","amount","parsed","parseFloat","isNaN","parseSlippageTolerance","src","tolerance","StellarBrokerEvents","ensurePromise","callResult","Promise","resolve","reject","params","network","partnerKey","emitter","EventTarget","Networks","toUpperCase","flow","status","socket","origin","quoteRequest","lastQuote","tradeQuote","authorization","source","destination","connect","readyState","WebSocket","OPEN","encodeURIComponent","onmessage","processMessage","bind","onclose","console","log","onerror","e","error","confirm","expirationTimeout","setTimeout","onSocketOpen","heartbeat","clearTimeout","raw","JSON","parse","quote","ts","Date","dispatchEvent","processTxRequest","sold","bought","send","stop","sellingAsset","selling_asset","buyingAsset","buying_asset","sellingAmount","selling_amount","buyingAmount","buying_amount","slippageTolerance","slippage_tolerance","other","res","assign","validateQuoteRequest","then","confirmQuote","Keypair","fromSecret","tx","TransactionBuilder","fromXDR","xdr","validateTransaction","authorizeTx","networkFee","signatures","length","hash","toXDR","catch","sign","wrapped","buildFeeBumpTransaction","swap","operations","stringify","pingHandler","warn","close","on","callback","addEventListener","once","off","removeEventListener"],"sourceRoot":""}